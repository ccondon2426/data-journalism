---
title: "data.analysis.condon"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

```{r}

# Load Tidyverse, janitor and arcos, tidycensus, mapview, ggthemes, scales
library(tidyverse)
library(janitor)
library(arcos)
library(scales)
library(tidycensus)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("mapview")
library(mapview)
```

Storing key for ARCOS access.

```{r}
# store one of our API keys as an object called key
key <- "uO4EK6I"
```

Loading ARCOS county data.

```{r}

arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
 clean_names()

pharmacy_pill_totals <- combined_buyer_annual(county = "Mingo", state = "WV", key = key) %>%
  clean_names()

pharmacy_census_tract <- pharm_tracts(key = key) %>%
  clean_names()

tracts_pills_per_year <- pharmacy_pill_totals %>%
  inner_join(pharmacy_census_tract, by="buyer_dea_no")

```

Loading crosswalk, which connects Census tracts and Continuums of Care.

```{r}
crosswalk <- read_csv("data/crosswalk-coc-to-tract.csv")
```
 
Bringing in pills and population data for each Census tract in the country
```{r}
tract_pills <- read_csv("data/tract_pills.csv")
```

Filtering only for 2010, so that I can compare pills to population.

```{r}
tract_pills_2010 <- tract_pills %>%
  filter(year == "2010")
```

Getting population per CoC in 2010
```{r}
coc_pop <- tract_pills_2010 %>%
  inner_join(crosswalk, by =c("GEOID" = "tract_fips")) %>%
  group_by(coc_code) %>%
  summarise(total_2010_population = sum(total_2010_population))

```

Getting pills per CoC in 2010

```{r}
coc_pills <- tract_pills_2010  %>%
  inner_join(crosswalk, by =c("GEOID" = "tract_fips")) %>%
  group_by(coc_code) %>%
  summarise(total_pills = sum(total_pills))
```

Getting pills per person in each CoC in 2010
```{r}
coc_pills_per_person <- coc_pills %>%
  inner_join(coc_pop, by = "coc_code") %>%
  mutate(pills_per_capita = total_pills/total_2010_population) %>%
  arrange(desc(pills_per_capita))
```

Now, we want to get an average number of pills per CoC between 2006 and 2012, and divide that by the 2010 population.

```{r}
coc_pills_avg <- tract_pills %>%
  inner_join(crosswalk, by =c("GEOID" = "tract_fips")) %>%
 group_by(coc_code) %>%
 summarise(avg_pills = mean(total_pills))

coc_pills_per_person_avg <- coc_pills_avg %>%
 inner_join(coc_pills_per_person, by = "coc_code") %>%
  select(coc_code,avg_pills, total_2010_population) %>%
  mutate(pills_per_capita = avg_pills/total_2010_population) %>%
  arrange(desc(pills_per_capita))

  
```

Bringing in PIT Count data for comparison
```{r}
pit_count <- read_csv("data/hud-pit-all.csv")
```

Filtering for only 2014 data (the first year we really consider reliable)

```{r}
pit_count_2014 <- pit_count %>%
select(coc_code, ends_with("_2014"))
```

Now I want to join this with 'coc_pills_per_person_avg'

```{r}
homelessness_rate_pills_per_person <- coc_pills_per_person_avg %>%
  inner_join(pit_count_2014, by = "coc_code") %>%
  select(coc_code,avg_pills, total_2010_population, pills_per_capita, overall_homeless_2014) %>%
 mutate(homelessness_rate = overall_homeless_2014/total_2010_population) %>%
  arrange(desc(homelessness_rate))

```

Now I have a dataframe that shows me homelessness rate by coc's as well as the amount of pills person they received, on average, between 2006 and 2012 (based on 2010 census population figures). Yay! 

First, I'd like to see if there's any kind of correlation I can see between homelessness rates. Right off the bat, it looks like a bit of a mixed bag, seeing as DC, which has the second highest homelessness rate, has a pills rate of less than one per person. In the CoC with the highest homelessness rate, there are roughly 20 pills per person though. So let's take a look graphically. 

```{r}
ggplot(homelessness_rate_pills_per_person) +
 geom_point(aes(homelessness_rate, pills_per_capita)) +
 labs(x="Homelessness Rate", y="Pills per Capita", title="Low positive correlation between homelessness and opioid pills", caption = "Source: DEA ARCOS database, HUD PIT Count", fill="coc_code") +
 theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 geom_smooth(aes(homelessness_rate, pills_per_capita), method = "lm", se = FALSE) +
 geom_text(aes(homelessness_rate, pills_per_capita, label=coc_code))
```

PREVIOUS WORK: Answering questions that will be helpful for future analysis

Question 1: I know that Mendocino County, California had the highest rate of homelessness in 2017 based on PIT count data analysis by the Howard Center. How many opioids were shipped there between '06 and '12? 

```{r}
mendocino_pills_annual <- combined_buyer_annual(county = "Mendocino", state = "CA", key = key) %>%
  clean_names() %>%
group_by(buyer_dea_no) %>%
summarise(total_pills = sum(dosage_unit))%>%
mutate(county_pills =sum(total_pills))
  #38,751,915
```


Question 2: I know that Dearborn, Michigan had the lowest rate of homelessness in 2017 based on PIT count data analysis by the Howard Center.How many opioids were shipped there between '06 and '12? 

```{r}
wayne_pills_annual <- combined_buyer_annual(county = "Wayne", state = "MI", key = key) %>%
  clean_names() %>%
group_by(buyer_dea_no) %>%
summarise(total_pills = sum(dosage_unit))%>%
mutate(county_pills =sum(total_pills))
#618,073,160
```

Question 3: I know that Tuscaloosa, Alabama had the lowest percent cahnge in overall homelessness count between 2014 and 2018, according to Howard Center data analysis of the PIT Count. How many opioids were shipped there between '06 and '12?

```{r}
tuscaloosa_pills_annual <- combined_buyer_annual(county = "Tuscaloosa", state = "AL", key = key) %>%
  clean_names() %>%
group_by(buyer_dea_no) %>%
summarise(total_pills = sum(dosage_unit))%>%
mutate(county_pills =sum(total_pills))

#49,843,360
```

Question 4: I know that Imperial County, CA had the highest percent change in overall homelessness count between 2014 and 2018, according to Howard Center data analysis of the PIT Count. How many opioids were shipped there between '06 and '12?

```{r}
imperial_pills_annual <- combined_buyer_annual(county = "Imperial", state = "CA", key = key) %>%
  clean_names() %>%
group_by(buyer_dea_no) %>%
summarise(total_pills = sum(dosage_unit))%>%
mutate(county_pills =sum(total_pills))

#	23,887,210
```

Question 5: What's the average number of pills per person shipped to Mendocino County between '06 and '12?
```{r}
mendocino_yearly_pills <- summarized_county_annual(county = "Mendocino", state = "CA", key = key)

mendocino_population <- county_population(county = "Mendocino", state = "CA", key = key) 

mendocino_population_working <- subset(mendocino_population, select = c(year, population))

mendocino_per_capita <- inner_join(mendocino_population_working, mendocino_yearly_pills)

mendocino_finished <- mendocino_per_capita %>%
 mutate(pills_per_capita = DOSAGE_UNIT/population) %>%
mutate(avg_pills_per_capita = mean(pills_per_capita))

#63.47546 pills per person
```
Question 6: What's the average number of pills per person shipped to Wayne County between '06 and '12?

```{r}
wayne_yearly_pills <- summarized_county_annual(county = "Wayne", state = "MI", key = key)

wayne_population <- county_population(county = "Wayne", state = "MI", key = key) 

wayne_population_working <- subset(wayne_population, select = c(year, population))

wayne_per_capita <- inner_join(wayne_population_working, wayne_yearly_pills)

wayne_finished <- wayne_per_capita %>%
 mutate(pills_per_capita = DOSAGE_UNIT/population) %>%
mutate(avg_pills_per_capita = mean(pills_per_capita))

#46.9917 pills per person
```
Question 7: What's the average number of pills per person shipped to Tuscaloosa between '06 and '12?

```{r}
tusca_yearly_pills <- summarized_county_annual(county = "Tuscaloosa", state = "AL", key = key)

tusca_population <- county_population(county = "Tuscaloosa", state = "AL", key = key) 

tusca_population_working <- subset(tusca_population, select = c(year, population))

tusca_per_capita <- inner_join(tusca_population_working, tusca_yearly_pills)

tusca_finished <- tusca_per_capita %>%
 mutate(pills_per_capita = DOSAGE_UNIT/population) %>%
mutate(avg_pills_per_capita = mean(pills_per_capita))

#38.02098 pills per person
```
Question 8: What's the average number of pills per person shipped to Imperial County between '06 and '12?

```{r}
imp_yearly_pills <- summarized_county_annual(county = "Imperial", state = "CA", key = key)

imp_population <- county_population(county = "Imperial", state = "CA", key = key) 
imp_population_working <- subset(imp_population, select = c(year, population))

imp_per_capita <- inner_join(imp_population_working, imp_yearly_pills)

imp_finished <- imp_per_capita %>%
 mutate(pills_per_capita = DOSAGE_UNIT/population) %>%
mutate(avg_pills_per_capita = mean(pills_per_capita))

#20.41986 pills per person
```

Question 9: Which pharmacy in Mendocino County received the most pills in one year?

```{r}
mendocino_worst_pharmacy <- combined_buyer_annual(county= "Mendocino", state = "CA", key = key) %>%
  arrange(desc(DOSAGE_UNIT))
mendocino_buyer_details <- buyer_details(county="Mendocino", state="CA", key = key)

mendocino_worst_pharmacy_name <- mendocino_worst_pharmacy %>%
inner_join(mendocino_buyer_details, by= "BUYER_DEA_NO")
#MYERS MEDICAL PHARMACY in 2012
```
Question 10: Which pharmacy in Wayne County received the most pills in one year?

```{r}
wayne_worst_pharmacy <- combined_buyer_annual(county= "Wayne", state = "MI", key = key) %>%
  arrange(desc(DOSAGE_UNIT))
wayne_buyer_details <- buyer_details(county="Wayne", state="MI", key = key)

wayne_worst_pharmacy_name <- wayne_worst_pharmacy %>%
inner_join(wayne_buyer_details, by= "BUYER_DEA_NO")

#OMNICARE OF SOUTHERN MICHIGAN every year between 06 and 12

```

Question 11: Which pharmacy in Tuscaloosa received the most pills between '06 and '12?
```{r}
tusca_worst_pharmacy <- combined_buyer_annual(county= "Tuscaloosa", state = "AL", key = key) %>%
  arrange(desc(DOSAGE_UNIT))

tusca_buyer_details <- buyer_details(county="Tuscaloosa", state="AL", key = key)

tusca_worst_pharmacy_name <- tusca_worst_pharmacy %>%
inner_join(tusca_buyer_details, by= "BUYER_DEA_NO")

#SENIOR CARE PHARMACY every year between 06 and 12
```

Question 12: Which pharmacy in Imperial County received the most pills between '06 and '12?

```{r}
imperial_worst_pharmacy <- combined_buyer_annual(county= "Imperial", state = "CA", key = key) %>%
  arrange(desc(DOSAGE_UNIT))

imperial_buyer_details <- buyer_details(county="Imperial", state="CA", key = key)

imperial_worst_pharmacy_name <- imperial_worst_pharmacy %>%
inner_join(imperial_buyer_details, by= "BUYER_DEA_NO")

#The Walgreens the El Centro
```

Question 13: What does the graph of pills per capita per year look like for Mendocino?
```{r}
ggplot(mendocino_finished) +
 geom_point(aes(year, pills_per_capita)) +
 labs(x="Year", y="Pills per Person", title="Pills per capita  sent to Mendocino County between 20016 and 2012", caption = "Source: DEA ARCOS database, via Washington Post", fill="year") +
 theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 geom_smooth(aes(year, pills_per_capita), method = "lm", se = FALSE)
 #geom_text(aes(year, pills_per_capita, label=buyer_county))
```

Question 14: What does the graph of pills per capita per year look like for Wayne?

```{r}
ggplot(wayne_finished) +
 geom_point(aes(year, pills_per_capita)) +
 labs(x="Year", y="Pills per Person", title="Pills per capita sent to Wayne County between 20016 and 2012", caption = "Source: DEA ARCOS database, via Washington Post", fill="year") +
 theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 geom_smooth(aes(year, pills_per_capita), method = "lm", se = FALSE)
 #geom_text(aes(year, pills_per_capita, label=buyer_county))
```
Question 15: What does the graph of pills per capita per year look like for Tuscaloosa?
```{r}
ggplot(tusca_finished) +
 geom_point(aes(year, pills_per_capita)) +
 labs(x="Year", y="Pills per Person", title="Pills per capita sent to Tuscaloosa between 20016 and 2012", caption = "Source: DEA ARCOS database, via Washington Post", fill="year") +
 theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 geom_smooth(aes(year, pills_per_capita), method = "lm", se = FALSE)
 #geom_text(aes(year, pills_per_capita, label=buyer_county))
```
Question 16: What does the graph of pills per capita per year look like for Imperial?

```{r}
ggplot(imp_finished) +
 geom_point(aes(year, pills_per_capita)) +
 labs(x="Year", y="Pills per Person", title="Pills per capita sent to Imperial County between 20016 and 2012", caption = "Source: DEA ARCOS database, via Washington Post", fill="year") +
 theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
 geom_smooth(aes(year, pills_per_capita), method = "lm", se = FALSE)
 #geom_text(aes(year, pills_per_capita, label=buyer_county))
```
